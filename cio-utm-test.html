<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CIO UTM Persistence Test</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ── Design tokens (matched from index.css) ── */
    :root {
      --bg-color: #0F281E;
      --card-bg: rgba(20, 45, 35, 0.7);
      --text-primary: #f0fdf4;
      --text-secondary: #a3b8a8;
      --accent-color: #68826C;
      --accent-hover: #7da082;
      --border-color: rgba(104, 130, 108, 0.2);
      --success-color: #4ade80;
      --error-color: #f87171;
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    .app-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ── Header (gradient title matching App.jsx) ── */
    header {
      margin-top: 1.5rem;
      margin-bottom: 2rem;
      text-align: left;
    }
    header h1 {
      font-size: 2.5rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      margin-bottom: 0.5rem;
      background: linear-gradient(to right, #68826C, #86efac);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    header p {
      color: var(--text-secondary);
      font-size: 1.125rem;
    }

    /* ── Two-column grid (matches App.css main-grid) ── */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 400px;
      gap: 2rem;
      align-items: start;
    }
    .config-column {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .debug-column {
      position: sticky;
      top: 2rem;
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
    }
    @media (max-width: 768px) {
      .app-container { padding: 1rem; }
      .main-grid { grid-template-columns: 1fr; }
      .debug-column { position: static; max-height: none; overflow-y: visible; }
    }

    /* ── Card (matches index.css .card) ── */
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* ── Headings ── */
    h2 {
      margin: 0 0 1rem 0;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: -0.025em;
      color: var(--text-primary);
    }

    /* ── Status badge ── */
    .status {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-block;
    }
    .status.campaign {
      background: rgba(74, 222, 128, 0.15);
      color: var(--success-color);
      border: 1px solid rgba(74, 222, 128, 0.25);
    }
    .status.organic {
      background: rgba(248, 113, 113, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    /* ── Table ── */
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; }
    th { color: var(--text-secondary); font-weight: 500; }
    td.value { font-family: 'SF Mono', SFMono-Regular, Consolas, monospace; color: var(--text-primary); }
    .empty { color: var(--text-secondary); font-style: italic; opacity: 0.6; }

    /* ── URL display ── */
    .url-display {
      font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
      font-size: 0.8rem;
      word-break: break-all;
      color: var(--text-secondary);
      background: rgba(15, 23, 42, 0.3);
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-color);
    }

    /* ── Payload pre block (matches DebugConsole inner panel) ── */
    .payload-block {
      background: rgba(15, 23, 42, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      margin: 0;
    }

    /* ── Nav links (styled as btn-secondary) ── */
    .nav-links { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .nav-links a {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .nav-links a:hover {
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }
    .nav-links a.danger {
      background: rgba(248, 113, 113, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }
    .nav-links a.danger:hover {
      background: rgba(248, 113, 113, 0.2);
    }

    /* ── Script log (matches DebugConsole) ── */
    .log {
      background: rgba(15, 23, 42, 0.3);
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      min-height: 120px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }
    .log .entry { margin-bottom: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem; }
    .log .entry:last-child { border-bottom: none; margin-bottom: 0; }
    .log .timestamp { color: var(--text-secondary); }
    .log .level { font-weight: 600; }
    .log .entry.warn .level { color: #fbbf24; }
    .log .entry.info .level { color: var(--accent-color); }
    .log .msg { color: var(--text-primary); word-break: break-all; margin-top: 0.25rem; }

    /* ── Top nav (matches TopNav.jsx) ── */
    .top-nav {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0.75rem 0;
      margin-bottom: 0;
      border-bottom: 1px solid var(--border-color);
    }
    .top-nav .nav-brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      margin-right: 0.5rem;
      flex-shrink: 0;
    }
    .top-nav .nav-brand span {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      letter-spacing: -0.025em;
    }
    .top-nav .nav-links-top {
      display: flex;
      gap: 0.25rem;
    }
    .top-nav .nav-links-top a {
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      background: transparent;
      border: none;
    }
    .top-nav .nav-links-top a:hover {
      color: var(--text-primary);
      background: rgba(104, 130, 108, 0.1);
    }
    .top-nav .nav-links-top a.active {
      color: var(--text-primary);
      background: rgba(104, 130, 108, 0.2);
    }

    /* ── Helper text ── */
    .helper-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    .waiting-text {
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80px;
    }
  </style>
</head>
<body>

  <div class="app-container">
    <nav class="top-nav">
      <a href="/" class="nav-brand">
        <span>CIO Toolbox</span>
      </a>
      <div class="nav-links-top">
        <a href="/">Pipelines SDK</a>
        <a href="/cio-utm-test.html" class="active">UTM Persistence</a>
      </div>
    </nav>

    <header>
      <h1>UTM Persistence Test</h1>
      <p>Validate anonymous in-app message triggering via persisted UTM parameters.</p>
    </header>

    <div class="main-grid">
      <!-- ── Left column: config & data ── -->
      <div class="config-column">

        <!-- Visitor Status -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Visitor Type</h2>
            <div id="visitorStatus" class="status">Checking...</div>
          </div>
          <div class="url-display" id="currentUrl"></div>
        </div>

        <!-- UTM Values -->
        <div class="card">
          <h2>Stored UTM Values <span style="font-weight: 400; color: var(--text-secondary); font-size: 0.8rem;">(sessionStorage)</span></h2>
          <table>
            <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
            <tbody id="utmTable"></tbody>
          </table>
        </div>

        <!-- Simulated Page Data -->
        <div class="card">
          <h2>_cio.page() Payload</h2>
          <p class="helper-text">Data that would be sent to Customer.io on this page view:</p>
          <pre class="payload-block" id="pagePayload"></pre>
        </div>

        <!-- Navigation Test -->
        <div class="card">
          <h2>Test Navigation</h2>
          <p class="helper-text">Click these to simulate navigating. UTM data should persist even without query params.</p>
          <div class="nav-links">
            <a href="?">No UTMs</a>
            <a href="?utm_campaign=aaron_anon_persist">With test UTM</a>
            <a href="?utm_source=google&utm_medium=cpc&utm_campaign=aaron_anon_persist">Full UTM set</a>
            <a href="#" class="danger" onclick="sessionStorage.clear(); location.reload(); return false;">Clear &amp; Reset</a>
          </div>
        </div>
      </div>

      <!-- ── Right column: debug log ── -->
      <div class="debug-column">
        <div class="card" style="height: 100%; display: flex; flex-direction: column;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Script Log</h2>
            <span id="logCount" style="font-size: 0.875rem; color: var(--text-secondary);">0 events</span>
          </div>
          <div class="log" id="scriptLog">
            <div class="waiting-text">Waiting for events...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================================
    // Mock _cio so the persistence script runs without the real CIO snippet
    // =========================================================================
    var _cio = _cio || [];
    var _logCount = 0;

    _cio.page = function(title, data) {
      logMessage('info', '_cio.page("' + title + '", ' + JSON.stringify(data, null, 2) + ')');
    };

    // Logger — styled to match DebugConsole
    var logEl = document.getElementById('scriptLog');
    var logCountEl = document.getElementById('logCount');
    var waitingCleared = false;

    function logMessage(level, msg) {
      if (!waitingCleared) {
        logEl.innerHTML = '';
        waitingCleared = true;
      }
      _logCount++;
      logCountEl.textContent = _logCount + ' event' + (_logCount !== 1 ? 's' : '');

      var d = document.createElement('div');
      d.className = 'entry ' + level;

      var ts = document.createElement('span');
      ts.className = 'timestamp';
      ts.textContent = '[' + new Date().toLocaleTimeString() + '] ';

      var lv = document.createElement('span');
      lv.className = 'level';
      lv.textContent = level.toUpperCase();

      var header = document.createElement('div');
      header.appendChild(ts);
      header.appendChild(lv);

      var body = document.createElement('div');
      body.className = 'msg';
      body.textContent = msg;

      d.appendChild(header);
      d.appendChild(body);
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Capture console output
    var _origLog = console.log;
    var _origWarn = console.warn;
    console.log = function() {
      _origLog.apply(console, arguments);
      logMessage('info', Array.from(arguments).join(' '));
    };
    console.warn = function() {
      _origWarn.apply(console, arguments);
      logMessage('warn', Array.from(arguments).join(' '));
    };
  </script>

  <!-- ====== The actual persistence script (inline for testing) ====== -->
  <script>
    (function () {
      'use strict';

      var UTM_KEYS = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];

      function captureUtms() {
        var params = new URLSearchParams(window.location.search);
        UTM_KEYS.forEach(function (key) {
          var value = params.get(key);
          if (value) {
            sessionStorage.setItem(key, value);
            console.log('[cio-utm-persist] Captured ' + key + ' = ' + value);
          }
        });
      }

      function getStoredUtms() {
        var data = {};
        UTM_KEYS.forEach(function (key) {
          var value = sessionStorage.getItem(key);
          if (value) data[key] = value;
        });
        return data;
      }

      function hasUtms() {
        return UTM_KEYS.some(function (key) {
          return sessionStorage.getItem(key) !== null;
        });
      }

      function sendCioPage() {
        var utmData = getStoredUtms();

        if (!hasUtms()) {
          _cio.page(document.title, { url: window.location.href });
          console.log('[cio-utm-persist] Organic visitor — no UTM data attached');
          return;
        }

        var pageData = Object.assign({ url: window.location.href }, utmData);
        _cio.page(document.title, pageData);
      }

      captureUtms();
      sendCioPage();
    })();
  </script>

  <!-- ====== UI Updates ====== -->
  <script>
    var UTM_KEYS = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];

    // Show current URL
    document.getElementById('currentUrl').textContent = window.location.href;

    // Show visitor status
    var hasAny = UTM_KEYS.some(function(k) { return sessionStorage.getItem(k) !== null; });
    var statusEl = document.getElementById('visitorStatus');
    if (hasAny) {
      statusEl.textContent = 'Campaign Visitor';
      statusEl.className = 'status campaign';
    } else {
      statusEl.textContent = 'Organic Visitor';
      statusEl.className = 'status organic';
    }

    // Show UTM table
    var tbody = document.getElementById('utmTable');
    UTM_KEYS.forEach(function(key) {
      var tr = document.createElement('tr');
      var tdKey = document.createElement('td');
      tdKey.textContent = key;
      var tdVal = document.createElement('td');
      tdVal.className = 'value';
      var val = sessionStorage.getItem(key);
      if (val) {
        tdVal.textContent = val;
      } else {
        tdVal.innerHTML = '<span class="empty">not set</span>';
      }
      tr.appendChild(tdKey);
      tr.appendChild(tdVal);
      tbody.appendChild(tr);
    });

    // Show page payload
    var payload = { url: window.location.href };
    UTM_KEYS.forEach(function(key) {
      var val = sessionStorage.getItem(key);
      if (val) payload[key] = val;
    });
    document.getElementById('pagePayload').textContent = JSON.stringify(payload, null, 2);
  </script>

</body>
</html>
